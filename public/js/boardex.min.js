!function(){var a={apiKey:"AIzaSyDgNzcJS-zqj-I3yUUXJp7EXp-6Vd6XsOo",authDomain:"boardex-b8a9e.firebaseapp.com",databaseURL:"https://boardex-b8a9e.firebaseio.com",storageBucket:"boardex-b8a9e.appspot.com",messagingSenderId:"762957983152"};firebase.initializeApp(a)}();const a=firebase.auth(),b=firebase.database(),c=firebase.storage();!function(){a.onAuthStateChanged(a=>{a?(args=parseArgs(),args.hasOwnProperty("from")?"editgame"===args.from&&(location.href="editgame.html"):location.href="index.html"):console.log("not logged in")})}(),parseArgs=function(){var a=location.search.substring(1);if(""===a)return{};a=a.split("&");var b={};for(parameter of a){var c=parameter.split("=");b[c[0]]=unescape(c[1])}return b},function(){Vue.use(VueFire);var a=b.ref("games"),c=b.ref("tagging"),d=new Vue({el:"#app",data:{tags:[],titles:"",isShowAll:!0,isShowSidebar:!1},firebase:{games:a,allGames:a},methods:{filterGame:function(){if(d.tags.length<1)return d.isShowAll=!0,void(d.games=d.allGames);d.isShowAll=!1,d.titles="",d.games="",console.log("tags: "+JSON.stringify(d.tags));for(tag of d.tags){var a=c.child("tags/"+tag);a.once("value",a=>{console.debug(a.key),a.val()?Array.isArray(d.titles)?(console.debug("titles and titles[tag]"),console.debug(d.titles),console.debug(Object.keys(a.val())),d.titles=this.intersect(d.titles,Object.keys(a.val()))):d.titles=Object.keys(a.val()):d.titles=[],d.updateGameList(),console.log(d.titles)})}},intersect:function(a,b){return a.length<1||b.length<1?[]:a.filter(a=>{return b.indexOf(a)>=0})},updateGameList:function(){d.games=[];for(title of d.titles){var b=a.child(title);b.once("value",a=>{if(null!=a.val()){var b=a.val();b[".key"]=a.key,d.games.push(b)}})}},clearTags:function(){d.tags=[]},toggleSidebar:function(){console.debug("hey"),d.isShowSidebar=!d.isShowSidebar}}})}(),function(){Vue.use(VueFire);const a=3;var c=b.ref("games");new Vue({el:"#recommend_list",data:{games:[]},created:function(){var b=c.orderByKey().limitToLast(a);b.on("child_added",a=>{var b=a.val();b.title=a.key,this.games.push(b)})}})}(),function(){Vue.use(VueFire);var a=b.ref("games");new Vue({el:"#searchbar",data:{searchString:"",gamesList:[],loadedGamesList:[],displayList:[],isSearch:!1},created:function(){a.on("value",a=>{let b=[];a.forEach(a=>{b.push(a.key)}),this.gamesList=b,this.loadedGamesList=b})},methods:{initializeItems:function(){this.gamesList=this.loadedGamesList},search:function(){var a=this.searchString;return this.isSearch=!0,this.initializeItems(),a?(a=a.trim().toLowerCase(),this.gamesList=this.gamesList.filter(b=>{if(a)return b.toLowerCase().indexOf(a)>-1}),void console.log("final list: "+this.gamesList)):void(this.isSearch=!1)},submitSearch:function(){location.href="info.html?t="+this.gamesList[0]}}})}(),function(){Vue.use(VueFire);var a=b.ref("tagging"),c=new Vue({el:"#sidebar",data:{tags:[],games:""},methods:{filterGame:function(){c.games="",console.log("hey"),console.log("tags: "+JSON.stringify(c.tags));for(tag of c.tags){var b=a.child("tags/"+tag);b.once("value",a=>{console.debug(a.key),a.val()&&(c.games.length?(console.debug("games and games[tag]"),console.debug(c.games),console.debug(Object.keys(a.val())),c.games=this.intersect(c.games,Object.keys(a.val()))):c.games=Object.keys(a.val()),console.log(c.games))})}},intersect:function(a,b){return a.length<1||b.length<1?[]:a.filter(a=>{return b.indexOf(a)>=0})}}})}(),function(){a.onAuthStateChanged(b=>{a.currentUser||(alert("Please log in to add a game!"),location.href="login.html?from=editgame")})}(),function(){const b=document.getElementById("signup"),c=document.getElementById("signin"),d=document.getElementById("signout");d.addEventListener("click",b=>{a.signOut(),alert("You have succesfully signed out.")}),a.onAuthStateChanged(a=>{a?(console.log(a),console.log("logged in"),b.classList.add("hide"),c.classList.add("hide"),d.classList.remove("hide")):(console.log("not logged in"),b.classList.remove("hide"),c.classList.remove("hide"),d.classList.add("hide"))})}(),function(){var d=c.ref("games"),e=b.ref("games"),f=b.ref("ratings");Vue.use(VueFire),a.onAuthStateChanged(b=>{var c=new Vue({el:"#game_spec",data:{lastImg:"",imgFile:"",game:{title:"",desc:"",imgUrl:"",playerMin:"",playerMax:"",age:""},rating:{title:"",funRating:0,funTotal:0,funNum:0,diffRating:0,diffTotal:0,diffNum:0,chaRating:0,chaTotal:0,chaNum:0},isUpdateMode:!1,isUploading:!1,alertPlayer:!1,alertSuccess:!1,alertFaliure:!1,alertPermission:!1},firebase:{games:e,ratings:f},created:function(){if(args=parseArgs(),args.hasOwnProperty("t")&&""!=args.t){console.log("switched to update mode"),this.isUpdateMode=!0;var a=e.child(args.t);a.once("value",a=>{console.debug(a.val()),null==a.val()&&(location.href="404.html"),this.game=a.val(),this.game.title=a.key})}else console.log("switched to add mode")},methods:{editgame:function(){return this.alertPlayer=!1,this.alertSuccess=!1,this.alertFaliure=!1,this.alertPermission=!1,this.isUploading=!1,this.game.title=this.game.title.trim(),this.game.desc=this.game.desc.trim(),this.game.playerMin=parseInt(this.game.playerMin),this.game.playerMax=parseInt(this.game.playerMax),this.game.age=this.game.age.trim(),isValid=this.game.title&&this.game.desc&&this.game.imgUrl&&this.game.age&&this.game.playerMin&&this.game.playerMax,(this.game.playerMin<1||this.game.playerMax<this.game.playerMin)&&(this.alertPlayer=!0,isValid=!1),isValid?(this.isUploading=!0,void(this.isUpdateMode?this.updateGame():this.addGame())):void(this.alertFaliure=!0)},addGame:function(){requireImg=function(){console.log("missing image file")},add=function(){console.log("pushing"),f.child(c.game.title).set({funRating:0,funTotal:0,funNum:0,diffRating:0,diffTotal:0,diffNum:0,chaRating:0,chaTotal:0,chaNum:0}),e.child(c.game.title).set({desc:c.game.desc,imgUrl:c.game.imgUrl,playerMin:c.game.playerMin,playerMax:c.game.playerMax,age:c.game.age,uid:a.currentUser.uid}).then(function(a){this.alertSuccess=!0,location.href="info.html?t="+c.game.title},function(a){this.alertFaliure=!0})},this.uploadImageWithCallBack(requireImg,add)},updateGame:function(){update=function(){console.log("updating"),e.child(c.game.title).update({desc:c.game.desc,imgUrl:c.game.imgUrl,playerMin:c.game.playerMin,playerMax:c.game.playerMax,age:c.game.age}).then(function(a){this.alertSuccess=!0,location.href="info.html?t="+c.game.title},function(a){"PERMISSION_DENIED"===a.code?(this.alertFaliure||(this.alertPermission=!0),location.href="index.html"):this.alertFaliure=!0})},this.uploadImageWithCallBack(update,update)},onGameImageChange:function(a){var b=a.target.files||a.dataTransfer.files;if(!b.length)return void(c.game.imgUrl="");this.imgFile=b[0];var d=new FileReader;d.onload=function(a){c.game.imgUrl=a.target.result},d.readAsDataURL(this.imgFile)},uploadImageWithCallBack:function(b,e){if(!this.imgFile)return void b();if(this.imgFile==this.lastImg)return void e();console.log("uploading original image");var f=d.child(a.currentUser.uid+"/"+this.game.title+"/image"),g=f.put(this.imgFile);g.on("state_changed",function a(b){var a=b.bytesTransferred/b.totalBytes*100;console.log("uploading image: "+a)},function(b){console.log("upload failed!")},function(){console.log("upload complete!"),c.optimizeImg(g.snapshot.downloadURL,e),c.lastImg=c.imgFile})},optimizeImg:function(b,e){console.log("fetching optimized image");const f="http://res.cloudinary.com/law4d4rh3/image/fetch/",g="h_280,",h="q_40,",i="f_jpg/";optUrl=f+g+h+i+escape(b),console.debug(optUrl);var j=new Image;j.setAttribute("crossOrigin","anonymous"),j.onload=function(){var b=document.createElement("canvas");b.width=this.width,b.height=this.height;var f=b.getContext("2d");f.drawImage(this,0,0),console.debug("hehe"),b.toBlob(b=>{console.debug(b),console.log("uploading optimized image");var f=d.child(a.currentUser.uid).child(c.game.title+"/image"),g=f.put(b);g.on("state_changed",function a(b){var a=b.bytesTransferred/b.totalBytes*100;console.log("uploading image: "+a)},function(b){console.log("upload failed!")},function(){console.log("upload complete!"),c.game.imgUrl=g.snapshot.downloadURL,e()})})},j.src=optUrl}}})})}(),function(){function h(a){return atpos=a.indexOf("@"),dotpos=a.lastIndexOf("."),!(atpos<1||dotpos-atpos<2)}const b=document.getElementById("usr_email"),c=document.getElementById("usr_pwd"),d=document.getElementById("login_btn"),e=document.getElementById("signup_btn"),f=document.getElementById("emailAlert"),g=document.getElementById("passwordAlert");d.addEventListener("click",d=>{function k(a){console.log("succesfully logged in")}function l(a){f.classList.add("hide"),g.classList.add("hide"),h(e)?(a.message="The password is invalid or the user does not have a password.")&&g.classList.remove("hide"):f.classList.remove("hide")}const e=b.value,i=c.value,j=a.signInWithEmailAndPassword(e,i);j.catch(a=>console.log(a.message)),j.then(k,l)}),e.addEventListener("click",a=>{document.location.href="signup.html"+window.location.search})}(),function(){function k(a){return atpos=a.indexOf("@"),dotpos=a.lastIndexOf("."),!(atpos<1||dotpos-atpos<2)}const b=document.getElementById("usr_email"),c=document.getElementById("usr_password"),d=document.getElementById("usr_password_check"),e=document.getElementById("signup_btn"),f=document.getElementById("login"),g=document.getElementById("emailAlert"),h=document.getElementById("duplicateAlert"),i=document.getElementById("passwordAlert"),j=document.getElementById("matchAlert");e.addEventListener("click",e=>{function r(a){console.log("succesfully signed up")}function s(a){"The email address is already in use by another account."==a.message&&n&&o&&p&&h.classList.remove("hide")}const f=b.value,l=c.value,m=d.value;g.classList.add("hide"),i.classList.add("hide"),j.classList.add("hide"),h.classList.add("hide");var n=k(f),o=l.length>=6,p=l===m;if(console.log(o),n)if(o){if(!p)return void j.classList.remove("hide")}else i.classList.remove("hide");else g.classList.remove("hide");const q=a.createUserWithEmailAndPassword(f,l);q.catch(a=>console.log(a.message)),q.then(r,s)}),f.addEventListener("click",a=>{location.href="login.html"+location.search})}(),function(){Vue.use(VueFire);var c=b.ref("games"),d=b.ref("tagging"),e=b.ref("ratings"),f=function(a){c.child(a).remove().then(function(a){location.href="index.html"},function(a){"PERMISSION_DENIED"===a.code?alert("Error: You do not have permission to delete this game."):alert("Error: "+a.message)})};window.addEventListener("load",function(){args=parseArgs();var b=new Vue({el:"#game_info",data:{isUser:"",isOwner:"",isRating:"",game:"",formattedDesc:"",tags:[],newtag:"",rating:"",loginAlert:!1,funInput:"",diffInput:"",chaInput:""},created:function(){var a=c.child(args.t);a.once("value",a=>{null==a.val()&&(location.href="404.html"),this.game=a.val(),this.game.title=a.key,this.formattedDesc=marked(this.game.desc,{sanitize:!0}),this.checkOwnership()}),a.on("child_changed",a=>{this.game[a.key]=a.val()});var a=d.child("games/"+args.t);a.once("value",a=>{a.val()&&(b.tags=Object.keys(a.val()))});var f=e.child(args.t);f.once("value",a=>{this.rating=a.val(),this.rating.title=a.key}),f.on("child_changed",a=>{this.rating[a.key]=a.val()})},watch:{newtag:function(a,b){const c=this.tags.indexOf(a)<0,d=a&&c;d&&this.addTag(a),this.newtag=""}},methods:{updateGame:function(){console.log("updating"),console.log("redirecting to the edit page"),location.href="editgame.html?t="+this.game.title},deleteGame:function(){console.log("deleting"),confirm("Are you sure you want delete this game for good?")&&f(args.t)},checkOwnership:function(){a.onAuthStateChanged(a=>{this.isUser=null!=a,this.isOwner=null!=a&&a.uid===this.game.uid})},addTag:function(a){this.tags.push(a);var b={},c={};b[this.game.title]=!0,c[a]=!0;var e=d.child("tags/");e.child(a).update(b);var f=d.child("games/");f.child(this.game.title).update(c)},checkUser:function(){a.onAuthStateChanged(a=>{this.isRating=null!=a}),this.isRating||(this.loginAlert=!0)},saveRating:function(){console.log("FunInput: "+this.funInput),console.log("DiffInput: "+this.diffInput),this.isRating=!this.isRating;var a=parseInt(this.funInput)+parseInt(this.rating.funTotal),c=this.rating.funNum+1,d=parseInt(this.diffInput)+parseInt(this.rating.diffTotal),f=this.rating.diffNum+1,g=parseInt(this.chaInput)+parseInt(this.rating.chaTotal),h=this.rating.diffNum+1;console.log("newFunTotal: "+a),console.log("newFunNum: "+c),console.log("newDiffTotal: "+d),console.log("newDiffNum: "+f),this.funInput&&e.child(b.game.title).update({funRating:parseInt(a/c),funTotal:a,funNum:c}).then(function(a){console.log("rating saved succesfully")},function(a){console.log("rating failed")}),this.diffInput&&e.child(b.game.title).update({diffRating:parseInt(d/f),diffTotal:d,diffNum:f}).then(function(a){console.log("rating saved succesfully")},function(a){console.log("rating failed")}),this.chaInput&&e.child(b.game.title).update({chaRating:parseInt(g/h),chaTotal:g,chaNum:h}).then(function(a){console.log("rating saved succesfully")},function(a){console.log("rating failed")})}}})})}(),function(){const a=new firebase.auth.GoogleAuthProvider,d=(document.getElementById("usr_email"),document.getElementById("usr_pwd"),document.getElementById("google_login_btn"));d.addEventListener("click",b=>{firebase.auth().getRedirectResult().then(function(b){var c=b.user;c||(console.log("redirect to sign in with google"),firebase.auth().signInWithRedirect(a))}).catch(function(a){var b=a.message;alert(b)})})}();